{
  "hash": "bbb32724cef8d9c225c9002621599126",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"02 Supervised Machine Learning Regression\"\nauthor: \"Maximilian Muza\"\nparams:\n  data_dir: \"../../data/\"\n---\n\n\nLoad the absolute path to the data directory.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_dir <- params$data_dir\n```\n:::\n\n\n# Libraries\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidymodels)\nlibrary(tidyverse)\nlibrary(recipes)\nlibrary(rsample)\nlibrary(yardstick)\n```\n:::\n\n\n# Data\n\n::: {.cell}\n\n```{.r .cell-code}\nbike_features_tbl <- readRDS(file.path(data_dir, \"bike_features_tbl.rds\"))\nbike_features_tbl |> as_tibble() |> print()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 231 × 67\n#>    bike_id model    model_year frame_material weight price category_1 category_2\n#>      <dbl> <chr>         <dbl> <chr>           <dbl> <dbl> <chr>      <chr>     \n#>  1    2875 Aeroad …       2020 carbon           7.6   4579 Road       Race      \n#>  2    2873 Aeroad …       2020 carbon           7.27  6919 Road       Race      \n#>  3    2874 Aeroad …       2020 carbon           7.1   6429 Road       Race      \n#>  4    2876 Aeroad …       2020 carbon           7.73  5069 Road       Race      \n#>  5    2877 Aeroad …       2020 carbon           7.83  3609 Road       Race      \n#>  6    2225 Aeroad …       2019 carbon           6.8   6139 Road       Race      \n#>  7    2091 Aeroad …       2019 carbon           6.8   5359 Road       Race      \n#>  8    2086 Aeroad …       2021 carbon           7.6   2629 Road       Race      \n#>  9    2088 Aeroad …       2020 carbon           7.3   3699 Road       Race      \n#> 10    2120 Aeroad …       2020 carbon           7.2   3219 Road       Race      \n#> # ℹ 221 more rows\n#> # ℹ 59 more variables: category_3 <chr>, gender <chr>, url <chr>, Frame <chr>,\n#> #   Fork <chr>, `Rear Derailleur` <chr>, `Front Derailleur` <chr>,\n#> #   Cassette <chr>, Crank <chr>, `Bottom bracket` <chr>, `Thru Axle` <chr>,\n#> #   Cockpit <chr>, Saddle <chr>, Seatpost <chr>, Pedals <chr>,\n#> #   `Derailleur hanger` <chr>, Battery <chr>, Brake <chr>, `Shift Lever` <chr>,\n#> #   Chain <chr>, Stem <chr>, Handlebar <chr>, Headset <chr>, Motor <chr>, …\n```\n\n\n:::\n:::\n\n\nTransform dataset\n\n::: {.cell}\n\n```{.r .cell-code}\nbike_features_trafo_tbl <- bike_features_tbl %>% \n    select(model:url, `Rear Derailleur`, `Shift Lever`) %>%\n    mutate_if(is.numeric, ~replace(., is.na(.), 0)) %>%\n    mutate(id = row_number()) %>% \n    select(id, everything(), -url)\nbike_features_trafo_tbl |> as_tibble() |> print()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 231 × 12\n#>       id model      model_year frame_material weight price category_1 category_2\n#>    <int> <chr>           <dbl> <chr>           <dbl> <dbl> <chr>      <chr>     \n#>  1     1 Aeroad CF…       2020 carbon           7.6   4579 Road       Race      \n#>  2     2 Aeroad CF…       2020 carbon           7.27  6919 Road       Race      \n#>  3     3 Aeroad CF…       2020 carbon           7.1   6429 Road       Race      \n#>  4     4 Aeroad CF…       2020 carbon           7.73  5069 Road       Race      \n#>  5     5 Aeroad CF…       2020 carbon           7.83  3609 Road       Race      \n#>  6     6 Aeroad CF…       2019 carbon           6.8   6139 Road       Race      \n#>  7     7 Aeroad CF…       2019 carbon           6.8   5359 Road       Race      \n#>  8     8 Aeroad CF…       2021 carbon           7.6   2629 Road       Race      \n#>  9     9 Aeroad CF…       2020 carbon           7.3   3699 Road       Race      \n#> 10    10 Aeroad WM…       2020 carbon           7.2   3219 Road       Race      \n#> # ℹ 221 more rows\n#> # ℹ 4 more variables: category_3 <chr>, gender <chr>, `Rear Derailleur` <chr>,\n#> #   `Shift Lever` <chr>\n```\n\n\n:::\n:::\n\n\nCreate training and testing dataset (Hold-out method)\n\n::: {.cell}\n\n```{.r .cell-code}\nbike_features_trafo_tbl %>% distinct(category_2) %>% print()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 20 × 1\n#>    category_2    \n#>    <chr>         \n#>  1 Race          \n#>  2 Endurance     \n#>  3 E-Road        \n#>  4 Cyclocross    \n#>  5 Triathlon Bike\n#>  6 Fat Bikes     \n#>  7 Cross-Country \n#>  8 Adventure     \n#>  9 All-Road      \n#> 10 E-Gravel      \n#> 11 Trail         \n#> 12 E-Mountain    \n#> 13 Downhill      \n#> 14 Dirt Jump     \n#> 15 Enduro        \n#> 16 E-City        \n#> 17 E-Trekking    \n#> 18 E-Fitness     \n#> 19 City          \n#> 20 Touring\n```\n\n\n:::\n\n```{.r .cell-code}\nset.seed(123)\nsplit <- initial_split(bike_features_trafo_tbl, prop = 3/4, strata = \"category_2\")\n\nsplit %>% training() %>% distinct(category_2) %>% print()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 19 × 1\n#>    category_2    \n#>    <chr>         \n#>  1 Race          \n#>  2 Endurance     \n#>  3 Cyclocross    \n#>  4 Triathlon Bike\n#>  5 Fat Bikes     \n#>  6 Cross-Country \n#>  7 All-Road      \n#>  8 E-Gravel      \n#>  9 E-Mountain    \n#> 10 Downhill      \n#> 11 Dirt Jump     \n#> 12 Enduro        \n#> 13 E-City        \n#> 14 E-Trekking    \n#> 15 E-Fitness     \n#> 16 Touring       \n#> 17 City          \n#> 18 Adventure     \n#> 19 Trail\n```\n\n\n:::\n\n```{.r .cell-code}\nsplit %>% testing() %>% distinct(category_2) %>% print()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 15 × 1\n#>    category_2    \n#>    <chr>         \n#>  1 Race          \n#>  2 Endurance     \n#>  3 E-Road        \n#>  4 Cyclocross    \n#>  5 Triathlon Bike\n#>  6 Cross-Country \n#>  7 Adventure     \n#>  8 E-Gravel      \n#>  9 All-Road      \n#> 10 Trail         \n#> 11 E-Mountain    \n#> 12 Enduro        \n#> 13 E-Trekking    \n#> 14 City          \n#> 15 Touring\n```\n\n\n:::\n\n```{.r .cell-code}\ntrain_tbl <- training(split)\ntest_tbl  <- testing(split)\n\ntrain_tbl <- train_tbl %>% set_names(str_replace_all(names(train_tbl), \" |-\", \"_\"))\ntest_tbl  <- test_tbl  %>% set_names(str_replace_all(names(test_tbl),  \" |-\", \"_\"))\n```\n:::\n\n\n\n# Model Construction\nFirst step involves building a ML model.\n\n::: {.cell}\n\n```{.r .cell-code}\nlinear_reg_model <- linear_reg(mode = \"regression\") %>%\n    set_engine(\"lm\")\nlinear_reg_model %>% print()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> Linear Regression Model Specification (regression)\n#> \n#> Computational engine: lm\n```\n\n\n:::\n:::\n\n\n\n# Feature Creation\nIn this step, features are being created by the use of the recipe package.\n\n::: {.cell}\n\n```{.r .cell-code}\n# Determine feature trafo\nbike_recipe <- recipe(price ~ category_2 + frame_material, data = train_tbl) %>%\n  step_rm(url, model) %>%\n  step_dummy(all_nominal(), -all_outcomes(), one_hot = TRUE)\nbike_recipe\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n#> \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n#> ── Recipe ──────────────────────────────────────────────────────────────────────\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n#> \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n#> ── Inputs\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n#> Number of variables by role\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n#> outcome:   1\n#> predictor: 2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n#> \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n#> ── Operations\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n#> • Variables removed: url and model\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n#> • Dummy variables from: all_nominal() and -all_outcomes()\n```\n\n\n:::\n:::\n\n\n\n# Model and Recipe Bundling \nThe ML model and the recipe is being bundled by the use of the workflow package.\n\n::: {.cell}\n\n```{.r .cell-code}\nbike_workflow <- workflow() %>% \n  add_model(linear_reg_model) %>% \n  add_recipe(bike_recipe) %>%\n  fit(data = train_tbl)\nbike_workflow\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> ══ Workflow [trained] ══════════════════════════════════════════════════════════\n#> Preprocessor: Recipe\n#> Model: linear_reg()\n#> \n#> ── Preprocessor ────────────────────────────────────────────────────────────────\n#> 2 Recipe Steps\n#> \n#> • step_rm()\n#> • step_dummy()\n#> \n#> ── Model ───────────────────────────────────────────────────────────────────────\n#> \n#> Call:\n#> stats::lm(formula = ..y ~ ., data = data)\n#> \n#> Coefficients:\n#>                                           (Intercept)  \n#>                                            -1.112e+06  \n#>                                            model_year  \n#>                                             5.510e+02  \n#>                                                weight  \n#>                                             1.913e+02  \n#>                              frame_material_aluminium  \n#>                                            -8.989e+02  \n#>                                 frame_material_carbon  \n#>                                                    NA  \n#>                                    category_1_E.Bikes  \n#>                                             1.633e+03  \n#>                                     category_1_Gravel  \n#>                                             1.294e+03  \n#>                              category_1_Hybrid...City  \n#>                                             1.188e+03  \n#>                                   category_1_Mountain  \n#>                                             1.539e+03  \n#>                                       category_1_Road  \n#>                                                    NA  \n#>                                  category_2_Adventure  \n#>                                             9.525e+02  \n#>                                   category_2_All.Road  \n#>                                                    NA  \n#>                                       category_2_City  \n#>                                            -3.603e+03  \n#>                              category_2_Cross.Country  \n#>                                             6.363e+02  \n#>                                 category_2_Cyclocross  \n#>                                            -1.318e+03  \n#>                                  category_2_Dirt.Jump  \n#>                                             3.378e+01  \n#>                                   category_2_Downhill  \n#>                                            -2.931e+03  \n#>                                     category_2_E.City  \n#>                                             2.642e+02  \n#>                                  category_2_E.Fitness  \n#>                                             7.596e+02  \n#>                                   category_2_E.Gravel  \n#>                                            -9.307e+02  \n#>                                 category_2_E.Mountain  \n#>                                             1.732e+02  \n#>                                 category_2_E.Trekking  \n#>                                                    NA  \n#>                                  category_2_Endurance  \n#> \n#> ...\n#> and 220 more lines.\n```\n\n\n:::\n:::\n\n\n\n# Performance Measures \nModel evaluation by the use of the yardstick package\n\n::: {.cell}\n\n```{.r .cell-code}\nevaluation <- bike_workflow %>%\n  predict(new_data = test_tbl) %>%\n  bind_cols(test_tbl %>% select(price)) %>%\n  metrics(truth = price, estimate = .pred)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n#> Warning: ! There are new levels in a factor: `E-Road`.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n#> Warning: ! There are new levels in a factor: `Endurace:ON`.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n#> Warning: ! There are new levels in a factor: `Shimano Ultegra RX800 GS`, `SRAM X01 DH`,\n#>   `Shimano Saint M820 SS`, and `Shimano Deore, 10s`.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n#> Warning: ! There are new levels in a factor: `Shimano Saint M820 10s` and `Shimano XTR\n#>   M9100 12s`.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n#> Warning in predict.lm(object = object$fit, newdata = new_data, type =\n#> \"response\", : prediction from rank-deficient fit; consider predict(.,\n#> rankdeficient=\"NA\")\n```\n\n\n:::\n\n```{.r .cell-code}\nevaluation\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\".metric\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\".estimator\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\".estimate\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"rmse\",\"2\":\"standard\",\"3\":\"551.2850218\"},{\"1\":\"rsq\",\"2\":\"standard\",\"3\":\"0.9339415\"},{\"1\":\"mae\",\"2\":\"standard\",\"3\":\"392.2758843\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n\n# Visualization\n\n::: {.cell}\n\n```{.r .cell-code}\ng1 <- bike_features_trafo_tbl %>% \n    mutate(category_2 = as.factor(category_2) %>% \n           fct_reorder(price)) %>% \n    \n    ggplot(aes(category_2, price)) +\n    geom_violin() +\n    geom_jitter(width = 0.1, alpha = 0.5, color = \"#2dc6d6\") +\n    coord_flip() +\n    facet_wrap(~ frame_material) +\n    scale_y_continuous(labels = scales::dollar_format()) +\n    labs(\n        title = \"Unit Price for Each Model\",\n        y = \"\", x = \"Category 2\"\n    )\ng1\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n#> Warning: Groups with fewer than two datapoints have been dropped.\n#> ℹ Set `drop = FALSE` to consider such groups for position adjustment purposes.\n#> Groups with fewer than two datapoints have been dropped.\n#> ℹ Set `drop = FALSE` to consider such groups for position adjustment purposes.\n#> Groups with fewer than two datapoints have been dropped.\n#> ℹ Set `drop = FALSE` to consider such groups for position adjustment purposes.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](02_supervised_ml_regression_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}